---
title: "Descriptive Statistics and Data Analysis"
author: "Gracia Andriamiadana"
date: "02/08/2023"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(dplyr)
library(magrittr)
library(ggplot2)
library(lubridate)
library(broom.mixed)
library(vtable)
library(survival)
library(broom)
library(purrr)
library(arsenal)

setwd("/Users/BHCadmin/Documents/mres_gracia/")
```

## Load and edit data tables
```{r}
demographic_table <- read.csv("upd_demographics_table_UKB_data.tsv", header = T, sep = "\t")
cmr_measures_tbl <- read.csv("CMR_patients_in_UKB.tsv", header = T, sep = "\t")
bmi_tbl <- read.csv("BMI_of_patients_in_UKB.tsv", sep = "\t")
diabetes_tbl = read.csv("updated_diabetes_tbl.tsv", sep = "\t")
hypertension_tbl = read.csv("updated_hypertension_tbl.tsv", sep = "\t")
cholesterol_tbl = read.csv("updated_cholesterol_tbl.tsv", sep = "\t")

IHD_tbl = read.csv("updated_IHD_tbl.tsv", sep = "\t")
non_IHD_tbl = read.csv("updated_non_IHD_tbl.tsv", sep = "\t")
HF_tbl = read.csv("updated_HF_tbl.tsv", sep = "\t")
HA_tbl = read.csv("updated_HA_tbl.tsv", sep = "\t")
pericardial_tbl <- read.csv("updated_pericardial_tbl.tsv", sep = "\t")
stroke_tbl = read.csv("updated_stroke_tbl.tsv", sep = "\t")

BC_tbl <- read.csv("updated_BC_tbl.tsv", sep = "\t", header = T)
BC_ids <- BC_tbl %>% dplyr::filter(prevalent_status == 1) %>% select(f.eid)
nrow(BC_ids)
BC_ids <- as.vector(BC_ids$f.eid)

non_BC_ids <- BC_tbl %>% dplyr::filter(BC_status == 0) %>% select(f.eid)
nrow(non_BC_ids)
non_BC_ids <- as.vector(non_BC_ids$f.eid)

RT_tbl <- read.csv("updated_RT_tbl.tsv", sep = "\t", header = T)
RT_ids <- RT_tbl %>% dplyr::filter(RT_status == 1) %>% select(f.eid)
nrow(RT_ids)

RT_and_BC_ids <- intersect(as.vector(BC_ids), as.vector(RT_ids$f.eid))
length(RT_and_BC_ids)

no_RT_ids <- RT_tbl %>% dplyr::filter(RT_status == 0) %>% select(f.eid)
no_RT_and_BC_ids <- intersect(as.vector(BC_ids), as.vector(no_RT_ids$f.eid))
length(no_RT_and_BC_ids)

cmr_ids <- cmr_measures_tbl$f.eid
cmr_no_bc_ids <- intersect(cmr_ids, non_BC_ids)
length(cmr_no_bc_ids)

cmr_bc_ids <- intersect(cmr_ids, BC_ids)
length(cmr_bc_ids)

cmr_bc_rt_ids <- intersect(cmr_ids, RT_and_BC_ids)
length(cmr_bc_rt_ids)

cmr_bc_but_no_mrt <- intersect(cmr_ids, no_RT_and_BC_ids)
length(cmr_bc_but_no_mrt)

sample_df <- read.csv("analysis_sample_UKB_patients.tsv", sep = "\t")

# GLM_df <- readRDS("table_for_regression_models.rds")

```

## Data Preprocessing and Wrangling for summary stats

```{r preprocessing_of_demographics_table}
tmp <- demographic_table %>% dplyr:: select(contains("status"))
factor_cols <- names(tmp)

tmp <- demographic_table %>% dplyr:: select(contains("alc"))
factor_cols <- c(factor_cols, names(tmp))

df1 <- demographic_table %>% dplyr:: select(contains("ethnicity"))
factor_cols <- c(factor_cols, names(df1))

demographic_table <- demographic_table %>% mutate(across(all_of(factor_cols), factor))
demographic_table$recruitment_date <- ymd(demographic_table$recruitment_date)
demographic_table$sex <- factor(demographic_table$sex)
demographic_table$f.eid <- as.character(demographic_table$f.eid)

demographic_table$ethnicity_at_recruitment[demographic_table["ethnicity_at_recruitment"] != 1] <- 0
# demographic_table$ethnicity_at_recruitment[demographic_table["ethnicity_at_recruitment"] == -1000] <- NA
demographic_table$ethnicity_at_calib_visit[demographic_table["ethnicity_at_calib_visit"] == -1000] <- NA
demographic_table$ethnicity_at_imaging_visit1[demographic_table["ethnicity_at_imaging_visit1"] == -1000] <- NA

stroke_tbl_BC <- stroke_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_stroke = prevalent_status,
                                                                     incident_status_stroke = incident_status)

IHD_tbl_BC <- IHD_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_IHD = prevalent_status,
                                                                     incident_status_IHD = incident_status)

NICM_tbl_BC <- non_IHD_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_NICM = prevalent_status,
                                                                     incident_status_NICM = incident_status)

pericard_tbl_BC <- pericardial_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_pericard = prevalent_status,
                                                                     incident_status_pericard = incident_status)

HF_tbl_BC <- HF_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_HF = prevalent_status,
                                                                     incident_status_HF = incident_status)

myocard_tbl_BC <- HA_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_myocard_inf = prevalent_status,
                                                                     incident_status_myocard_inf = incident_status)

diabetes_tbl_BC <- diabetes_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% 
  rename(prev_status_diabetes = prevalent_status, 
         incident_status_diabetes = incident_status)
 

cholesterol_tbl_BC <- cholesterol_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% 
  rename(prev_status_cholesterol = prevalent_status, 
         incident_status_cholesterol = incident_status)

hypertension_tbl_BC <- hypertension_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% 
  rename(prev_status_hypertension = prevalent_status, 
         incident_status_hypertension = incident_status)

demographic_table$f.eid <- as.integer(demographic_table$f.eid)

df_list <- list(BC_tbl %>% select(-recruitment_date), 
                RT_tbl %>% select(-recruitment_date, -prevalent_status, -incident_status, -RT_session_date),
                demographic_table, bmi_tbl, diabetes_tbl_BC, hypertension_tbl_BC, cholesterol_tbl_BC,
                IHD_tbl_BC, NICM_tbl_BC, HF_tbl_BC, stroke_tbl_BC, pericard_tbl_BC, myocard_tbl_BC
                )

GLM_df <- df_list %>% reduce(full_join, by='f.eid')

tmp <- GLM_df %>% dplyr:: select(contains("status"))
factor_cols <- names(tmp)

tmp <- GLM_df %>% dplyr:: select(contains("alc"))
factor_cols <- c(factor_cols, names(tmp))

df1 <- GLM_df %>% dplyr:: select(contains("ethnicity"))
factor_cols <- c(factor_cols, names(df1))

GLM_df <- GLM_df %>% mutate(across(all_of(factor_cols), factor))
# data<-replace(df$Marks, df$Marks<0, 0)
GLM_df$recruitment_date <- ymd(GLM_df$recruitment_date)
GLM_df$BC_diagnosis_date <- ymd(GLM_df$BC_diagnosis_date)
# GLM_df$RT_session_date <- ymd(GLM_df$RT_session_date)
GLM_df$sex <- factor(GLM_df$sex)
GLM_df$time = as.numeric(difftime(time2 = GLM_df$recruitment_date, time1 = GLM_df$BC_diagnosis_date))
GLM_df$time[is.na(GLM_df$time)] <- 0

GLM_df <- GLM_df %>%
  mutate(
    alc_grouped = case_when(
      alc_intake_at_recruitment %in% c("6") ~ "Never",     # Group A and B into "Group1"
      alc_intake_at_recruitment %in% c("4", "5") ~ "Less than once a week",     # Group C and D into "Group2"
      alc_intake_at_recruitment %in% c("1", "2", "3") ~ "More than once a week",     # Group C and D into "Group2"
      alc_intake_at_recruitment %in% c("-3") ~ NA,     # Group C and D into "Group2"
      TRUE ~ alc_intake_at_recruitment                           # Keep other categories as-is
    )
  ) %>%
  mutate(
    smoking_grouped = case_when(
      smoking_status_at_recruitment %in% c("0", "1") ~ "Not smoking",     # Group C and D into "Group2"
      smoking_status_at_recruitment %in% c("2") ~ "Currently smoking",     # Group C and D into "Group2"
      smoking_status_at_recruitment %in% c("-3") ~ NA,     # Group C and D into "Group2"
      TRUE ~ smoking_status_at_recruitment                           # Keep other categories as-is
    )
  )

# nrow(GLM_df)
head(GLM_df, 20)

# write.table(GLM_df, file = "table_for_regression_models.tsv", sep = "\t")
# saveRDS(GLM_df, file = "table_for_regression_models.rds")
# GLM_df <- readRDS("table_for_regression_models.rds")
```

## Baseline Characteristics of Whole and Sub Samples

### CVDs and Demographics of whole and BC Sub Samples

```{r demographics_whole_sample}

# datvec = names(GLM_df)
# elements_2_remove = c("BC_status", "f.eid", "RT_status", "recruitment_date", "BC_diagnosis_date", "time",
#                       "ethnicity_at_calib_visit", "ethnicity_at_imaging_visit1", "alc_intake_at_calib_visit",
#                       "alc_intake_at_imaging_visit1", "alc_intake_at_imaging_visit2", "smoking_status_at_calib_visit",
#                       "smoking_status_at_imaging_visit1", "smoking_status_at_imaging_visit2", "mets_imaging_visit2)
# datvec = datvec[!(datvec %in% elements_2_remove)]
# paste(datvec, collapse = " + ")

test_df <- GLM_df
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% BC_ids)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% non_BC_ids)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% no_RT_and_BC_ids)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% RT_and_BC_ids)


table_for_summary_stats <- tableby(~BC_status + prevalent_status + incident_status + age_at_recruitment + sex + ethnicity_at_recruitment  + education_score + deprivation_index + alc_grouped + smoking_grouped  + mets_imaging_visit1 + bmi_recruitment+ prev_status_diabetes + incident_status_diabetes + prev_status_hypertension + incident_status_hypertension + prev_status_cholesterol + incident_status_cholesterol + prev_status_IHD + incident_status_IHD + prev_status_NICM + incident_status_NICM + prev_status_HF + incident_status_HF + prev_status_stroke + incident_status_stroke + prev_status_pericard + incident_status_pericard + prev_status_myocard_inf + incident_status_myocard_inf, data = test_df,
                      numeric.stats=c("N", "median", "q1q3"))

sum_table <- summary(table_for_summary_stats, text = NULL)
sum_table <- as.data.frame(sum_table)
View(sum_table)


# write.table(sum_table, 'summary_stats_whole_sample.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_BC_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_no_BC_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_BC_but_no_MRT_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_BC_and_MRT_patients.tsv', sep = "\t")

```

### CVDs and Demographics of CMR Sub Samples

```{r cmr_descriptive_stats}

# test_df <- GLM_df %>% dplyr::filter(f.eid %in% cmr_ids)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% cmr_bc_ids)
test_df <- GLM_df %>% dplyr::filter(f.eid %in% cmr_no_bc_ids)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% cmr_bc_but_no_mrt)
# test_df <- GLM_df %>% dplyr::filter(f.eid %in% cmr_bc_rt_ids)
nrow(test_df)

table_for_summary_stats <- tableby(~BC_status + prevalent_status + incident_status + age_at_recruitment + sex + ethnicity_at_recruitment  + education_score + deprivation_index + alc_grouped + smoking_grouped  + mets_imaging_visit1 + BMI + prev_status_diabetes + incident_status_diabetes + prev_status_hypertension + incident_status_hypertension + prev_status_cholesterol + incident_status_cholesterol + prev_status_IHD + incident_status_IHD + prev_status_NICM + incident_status_NICM + prev_status_HF + incident_status_HF + prev_status_stroke + incident_status_stroke + prev_status_pericard + incident_status_pericard + prev_status_myocard_inf + incident_status_myocard_inf, data = test_df,
                      numeric.stats=c("N", "median", "q1q3"))

sum_table <- summary(table_for_summary_stats, text = NULL)
sum_table <- as.data.frame(sum_table)
View(sum_table)

# write.table(sum_table, 'summary_stats_CMR-whole_sample.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_CMR-BC_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_CMR-no_BC_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_CMR-BC_but_no_MRT_patients.tsv', sep = "\t")
# write.table(sum_table, 'summary_stats_CMR-BC_and_MRT_patients.tsv', sep = "\t")

```

## Linear Regression Models for CMR measures

```{r}
# GLM_df <- GLM_df %>% dplyr::filter(f.eid %in% BC_ids)
# names(GLM_df)
cmr_df <- inner_join(cmr_measures_tbl, GLM_df, by = "f.eid")
names(cmr_df)
```



```{r lin_regression_model}

# cmr_df <- inner_join(cmr_measures_tbl, GLM_df, by = "f.eid")
lin_models <- list()


### LVEDVI
#### MODEL 1
formula = LVEDVI ~ BC_status + age_at_recruitment + sex  
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LDEVDI-Model1"
lin_models <- c(lin_models, tmp)
# summary(model1)

### MODEL 2
formula = LVEDVI ~ BC_status + age_at_recruitment + sex + bmi_recruitment +
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LDEVDI-Model2"
lin_models <- c(lin_models, tmp)
# summary(model1)

### LV MASS
#### MODEL 1
formula = LV_mass2 ~ BC_status + age_at_recruitment + sex 
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVM-Model1"
lin_models <- c(lin_models, tmp)
# summary(model1)

### MODEL 2
formula = LV_mass2 ~ BC_status + age_at_recruitment + sex + bmi_recruitment +
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVM-Model2"
lin_models <- c(lin_models, tmp)
# summary(model1)

### LVEF
#### MODEL 1
formula = LVEF ~ BC_status + age_at_recruitment + sex 
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVEF-Model1"
lin_models <- c(lin_models, tmp)
# summary(model1)

#### MODEL 2
formula = LVEF ~ BC_status + age_at_recruitment + sex + bmi_recruitment +
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVEF-Model2"
lin_models <- c(lin_models, tmp)
# summary(model1)

### LVGFI
#### MODEL 1
formula = LVGFI ~ BC_status + age_at_recruitment + sex
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVGFI-Model1"
lin_models <- c(lin_models, tmp)
# summary(model1)

#### MODEL 2
formula = LVGFI ~ BC_status + age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "LVGFI-Model2"
lin_models <- c(lin_models, tmp)
# summary(model1)

### GLS
#### MODEL 1
formula = GLS ~ BC_status + age_at_recruitment + sex
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "GLS-Model1"
lin_models <- c(lin_models, tmp)
# summary(model1)

#### MODEL 2
formula = GLS ~ BC_status + age_at_recruitment + sex + bmi_recruitment + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
model1 <- glm(formula, data = cmr_df)
tmp <- list(model1)
names(tmp) <- "GLS-Model2"
lin_models <- c(lin_models, tmp)
# summary(model1)

```

### Store lin. regression results in table
```{r}

# Step 1: Create a list of Cox models (you should have your own list)
print(length(lin_models))

# Step 2: Extract coefficients and p-values from each model, keeping track of model names
extract_model_info <- function(model, model_name) {
  summary_info <- summary(model)
  coef_table <- coef(summary_info)
  p_value_table <- coef_table[, "Pr(>|t|)"]
  # Extract confidence intervals
  conf_interval_table <- confint(model)
  conf_low <- conf_interval_table[, 1]
  conf_high <- conf_interval_table[, 2]
  
  # Combine the extracted information with the model name
  model_info <- data.frame(
    model = model_name,
    predictor = rownames(coef_table),
    coef = coef_table[, "Estimate"],
    conf_low = conf_low,
    conf_high = conf_high,
    p_value = p_value_table
  )
  
  # Format the p-values and include significance levels
  formatted_p_values <- format.pval(p_value_table, digits = 3)
  significance_levels <- ifelse(p_value_table < 0.001, "***",
                                 ifelse(p_value_table < 0.01, "**",
                                        ifelse(p_value_table < 0.05, "*", "")))
  
  # Combine the formatted p-values and significance levels with the extracted information
  model_info$p_value <- formatted_p_values
  model_info$significance <- significance_levels
  return(model_info)
}

# Step 3: Extract information from each linear regression model
combined_info <- data.frame()  # Initialize an empty data frame for the combined results

# Extract information from each named model and add it to the combined table
for (model_name in names(lin_models)) {
  model <- lin_models[[model_name]]
  model_info <- extract_model_info(model, model_name)
  combined_info <- bind_rows(combined_info, model_info)
}

# Specify the list of selected terms (predictors) to filter the combined table
# selected_terms <- c("BC_status1", "sex", "age_at_recruitment")  # Adjust this list as needed
selected_terms <- c("BC_status1")  # Adjust this list as needed

# Filter the combined table to include only the selected terms
filtered_combined_info <- combined_info %>%
  filter(predictor %in% selected_terms)

# Print the filtered combined table with model names, selected predictor names, coefficients, p-values, and confidence intervals
View(filtered_combined_info)

# write.table(filtered_combined_info, file = "results_lin_regressions_table.tsv", sep = "\t")
# saveRDS(filtered_combined_info, file = "results_lin_regressions_table.rds")
```

## Cox Regression Models for CVD outcomes


```{r cox_regressions}
cox_models <- c()

### NICM
#### Model 1
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_NICM, incident_status_NICM, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_NICM == 0)

formula = Surv(time, as.numeric(incident_status_NICM)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
tmp <- list(res.cox)
names(tmp) <- "NICM-Model1"
cox_models <- c(cox_models, tmp)
# summary(res.cox)

#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_NICM, incident_status_NICM, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_NICM == 0)

formula = Surv(time, as.numeric(incident_status_NICM)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "NICM-Model2"
cox_models <- c(cox_models, tmp)

### IHD
#### Model 1
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_IHD, incident_status_IHD, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_IHD == 0)

formula = Surv(time, as.numeric(incident_status_IHD)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "IHD-Model1"
cox_models <- c(cox_models, tmp)


#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_IHD, incident_status_IHD, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_IHD == 0)

formula = Surv(time, as.numeric(incident_status_IHD)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "IHD-Model2"
cox_models <- c(cox_models, tmp)


### Stroke
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_stroke, incident_status_stroke, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_stroke == 0)

formula = Surv(time, as.numeric(incident_status_stroke)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "Stroke-Model1"
cox_models <- c(cox_models, tmp)


#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_stroke, incident_status_stroke, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_stroke == 0)

formula = Surv(time, as.numeric(incident_status_stroke)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "Stroke-Model2"
cox_models <- c(cox_models, tmp)


### PERICARDIAL DISEASE
#### Model 1
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_pericard, incident_status_pericard, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_pericard == 0)

formula = Surv(time, as.numeric(incident_status_pericard)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "Pericard-Model1"
cox_models <- c(cox_models, tmp)

#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_pericard, incident_status_pericard, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_pericard == 0)

formula = Surv(time, as.numeric(incident_status_pericard)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "Pericard-Model2"
cox_models <- c(cox_models, tmp)


### MYOCARDIAL INFARCTION
#### Model 1
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_myocard_inf, incident_status_myocard_inf, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_myocard_inf == 0)

formula = Surv(time, as.numeric(incident_status_myocard_inf)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "MYOINF-Model1"
cox_models <- c(cox_models, tmp)


#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_myocard_inf, incident_status_myocard_inf, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_myocard_inf == 0)

formula = Surv(time, as.numeric(incident_status_myocard_inf)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "MYOINF-Model2"
cox_models <- c(cox_models, tmp)


### HEART FAILURE
#### Model 1
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_HF, incident_status_HF, 
         age_at_recruitment, sex, recruitment_date, time) %>% filter(prev_status_HF == 0)

formula = Surv(time, as.numeric(incident_status_HF)) ~ BC_status + age_at_recruitment + sex
res.cox  <- coxph(formula, data = test_df)
# summary(res.cox)
tmp <- list(res.cox)
names(tmp) <- "HF-Model1"
cox_models <- c(cox_models, tmp)

#### Model 2
test_df <- GLM_df %>% 
  select(f.eid, BC_status, BC_diagnosis_date, prev_status_HF, incident_status_HF, 
         age_at_recruitment, sex, recruitment_date, time, 
         smoking_status_at_recruitment, ethnicity_at_recruitment,
         deprivation_index, alc_intake_at_recruitment, mets_imaging_visit1,
         prev_status_diabetes, prev_status_hypertension, prev_status_cholesterol) %>% filter(prev_status_HF == 0)

formula = Surv(time, as.numeric(incident_status_HF)) ~ BC_status + 
  age_at_recruitment + sex + 
  smoking_status_at_recruitment + alc_intake_at_recruitment + 
  mets_imaging_visit1 + 
  deprivation_index + ethnicity_at_recruitment +
  prev_status_diabetes + prev_status_cholesterol + prev_status_hypertension
res.cox  <- coxph(formula, data = test_df)
tmp <- list(res.cox)
names(tmp) <- "HF-Model2"
cox_models <- c(cox_models, tmp)


# Step 2: Extract coefficients, p-values, and confidence intervals from each model
extract_model_info <- function(model) {
  # model_summary <- summary(model)
  # coef_table <- as.data.frame(model_summary$coefficients)
  # conf_interval_table <- as.data.frame(model_summary$conf.int)
  # p_value_table <- as.data.frame(model_summary$coefficients[, "Pr(>|z|)"])
  # 
  # # Combine the extracted information
  # model_info <- data.frame(
  #   coef_identifier = rownames(coef_table),
  #   coef = coef_table[, "coef"],
  #   conf_low = conf_interval_table[, "lower .95"],
  #   conf_high = conf_interval_table[, "upper .95"],
  #   p_value = p_value_table
  # )
  # 
  # # Format the p-values and include significance levels
  # formatted_p_values <- format.pval(p_value_table, digits = 3)
  # significance_levels <- ifelse(p_value_table < 0.001, "***",
  #                                ifelse(p_value_table < 0.01, "**",
  #                                       ifelse(p_value_table < 0.05, "*", "")))
  # 
  # # Combine the formatted p-values and significance levels with the extracted information
  # model_info$p_value <- formatted_p_values
  # model_info$significance <- significance_levels
  # 
  return(model_info)
}

# # Step 3: Extract information from each Cox model and filter for selected terms
# extracted_info_list <- lapply(cox_models, extract_model_info)
# filtered_info_list <- lapply(extracted_info_list, function(info) {
#   filter(info, coef_identifier %in% selected_terms)
# })
# 
# # Step 4: Combine the filtered information into a single data frame
# combined_info <- do.call(rbind, filtered_info_list)
# 
# # Print the combined table with coefficients, confidence intervals, and p-values for selected terms
# print(combined_info)

# write.table(combined_info, file = "results_cox_regressions_table.tsv", sep = "\t")
# saveRDS(combined_info, file = "results_cox_regressions_table.rds")
```

#### Store Cox regression results

```{r}

# Step 1: Create a list of Cox models (you should have your own list)
print(length(cox_models))

# Specify the list of terms (variables) you want to include in the final merged table
# selected_terms <- c("BC_status1", "sex", "age_at_recruitment")  # Adjust this list as needed
selected_terms <- c("BC_status1")  # Adjust this list as needed


# Step 2: Extract coefficients, p-values, and confidence intervals from each Cox model
extract_cox_model_info <- function(model, model_name) {
  summary_info <- summary(model)
  coef_table <- coef(summary_info)
  p_value_table <- coef_table[, "Pr(>|z|)"]
  
  # Extract confidence intervals
  conf_interval_table <- confint(model)
  conf_low <- conf_interval_table[, 1]
  conf_high <- conf_interval_table[, 2]
  
  # Combine the extracted information with the model name
  model_info <- data.frame(
    model = model_name,
    predictor = rownames(coef_table),
    coef = coef_table[, 1],
    p_value = p_value_table,
    conf_low = conf_low,
    conf_high = conf_high
  )
  
  # Format the p-values and include significance levels
  formatted_p_values <- format.pval(p_value_table, digits = 3)
  significance_levels <- ifelse(p_value_table < 0.001, "***",
                                 ifelse(p_value_table < 0.01, "**",
                                        ifelse(p_value_table < 0.05, "*", "")))
  
  # Combine the formatted p-values and significance levels with the extracted information
  model_info$p_value <- formatted_p_values
  model_info$significance <- significance_levels
  return(model_info)
}

# Step 3: Extract information from each Cox model and add the model name
combined_cox_info <- data.frame()  # Initialize an empty data frame for the combined results

# Extract information from each named Cox model and add it to the combined table
for (model_name in names(cox_models)) {
  cox_model <- cox_models[[model_name]]
  cox_model_info <- extract_cox_model_info(cox_model, model_name)
  combined_cox_info <- bind_rows(combined_cox_info, cox_model_info)
}

# Filter the combined table to include only the selected terms
filtered_cox_combined_info <- combined_cox_info %>%
  filter(predictor %in% selected_terms)

# Print the filtered combined table with model names, selected predictor names, coefficients, p-values, and confidence intervals
View(filtered_cox_combined_info)

# write.table(filtered_cox_combined_info, file = "results_cox_regressions_table.tsv", sep = "\t")
# saveRDS(filtered_cox_combined_info, file = "results_cox_regressions_table.rds")
```

## Plots for CMR measures regression results

```{r}
### code snippet from LILIANA

# Create a function to make the plots
plot_type <- function(df, chamber_vars, chamber_name) {
  # Filter the dataframe based on the cardiac chamber
  df <- df %>% filter(cmr_var %in% chamber_vars)

  # Convert cmr_var to a factor and specify the levels
  df$cmr_var <- factor(df$cmr_var, levels = rev(chamber_vars))

  # Create the plot
  p <- ggplot(df, aes(x = cmr_var, y = estimate, color = term)) +
    geom_point() +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
    scale_color_manual(values = c("#28ae80", "#2c728e", "#472d7b")) +
    labs(title = paste0(chamber_name, " association with sports type"), 
         x = "CMR Variable", y = "Beta coefficient", color = "Sport type") +
    theme_minimal() +
    theme(legend.position = "right") +
    coord_flip()

  return(p)
}

 

# Now you can call the function as before
LV_plot <- plot_type(sport_type_results, LV_vars, "LV")
RV_plot <- plot_type(sport_type_results, RV_vars, "RV")
LA_plot <- plot_type(sport_type_results, LA_vars, "LA")
RA_plot <- plot_type(sport_type_results, RA_vars, "RA")

 

# Display the plots
gridExtra::grid.arrange(LV_plot, RV_plot, LA_plot, RA_plot, ncol = 1)
```



