---
title: "Descriptive Statistics and Data Analysis"
author: "Gracia Andriamiadana"
date: "02/08/2023"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(dplyr)
library(magrittr)
library(ggplot2)
library(lubridate)

setwd("/Users/BHCadmin/Documents/mres_gracia/")
```

## Load and edit data tables
```{r}
setwd("/Users/BHCadmin/Documents/mres_gracia/")

demographic_table <- read.csv("upd_demographics_table_UKB_data.tsv", header = T, sep = "\t")
cmr_measures_tbl <- read.csv("CMR_patients_in_UKB.tsv", header = T, sep = "\t")

diabetes_tbl = read.csv("updated_diabetes_tbl.tsv", sep = "\t")
hypertension_tbl = read.csv("updated_hypertension_tbl.tsv", sep = "\t")
cholesterol_tbl = read.csv("updated_cholesterol_tbl.tsv", sep = "\t")

IHD_tbl = read.csv("updated_IHD_tbl.tsv", sep = "\t")
non_IHD_tbl = read.csv("updated_non_IHD_tbl.tsv", sep = "\t")
HF_tbl = read.csv("updated_HF_tbl.tsv", sep = "\t")
HA_tbl = read.csv("updated_HA_tbl.tsv", sep = "\t")
pericardial_tbl <- read.csv("updated_pericardial_tbl.tsv", sep = "\t")
stroke_tbl = read.csv("updated_stroke_tbl.tsv", sep = "\t")

BC_tbl <- read.csv("updated_BC_tbl.tsv", sep = "\t", header = T)
BC_ids <- BC_tbl %>% dplyr::filter(BC_status == 1) %>% select(f.eid)
nrow(BC_ids)
BC_ids <- as.vector(BC_ids$f.eid)

non_BC_ids <- BC_tbl %>% dplyr::filter(BC_status == 0) %>% select(f.eid)
nrow(non_BC_ids)
non_BC_ids <- as.vector(non_BC_ids$f.eid)

RT_tbl <- read.csv("updated_RT_tbl.tsv", sep = "\t", header = T)
RT_ids <- RT_tbl %>% dplyr::filter(RT_status == 1) %>% select(f.eid)
nrow(RT_ids)

RT_and_BC_ids <- intersect(as.vector(BC_ids), as.vector(RT_ids$f.eid))
length(RT_and_BC_ids)

no_RT_ids <- RT_tbl %>% dplyr::filter(RT_status == 0) %>% select(f.eid)
no_RT_and_BC_ids <- intersect(as.vector(BC_ids), as.vector(no_RT_ids$f.eid))
length(no_RT_and_BC_ids)

sample_df <- read.csv("analysis_sample_UKB_patients.tsv", sep = "\t")
```


## Baseline Characteristics of Whole Sample

### CVDs

```{r whole_sample_CVDs}

paste("Prevelant Cases of Pericardial Disease:", sum(updated_pericardial_tbl$prevalent_status))
paste("Incident Cases of Pericardial Disease:", sum(updated_pericardial_tbl$incident_status))

paste("Prevelant Cases of MYO INF:", sum(updated_HA_tbl$prevalent_status))
paste("Incident Cases of HYO INF:", sum(updated_HA_tbl$incident_status))


```

### Demographics

```{r demographics_whole_sample}
View(t3)

# calculate average and median age of whole sample
mean(demographic_table$age_at_recruitment, na.rm = T)
median(demographic_table$age_at_recruitment, na.rm = T)

table(demographic_table$ethnicity_at_recruitment)

mean(demographic_table$deprivation_index, na.rm = T)
median(demographic_table$deprivation_index, na.rm = T)

(table(demographic_table$alc_intake_at_recruitment))

(table(demographic_table$smoking_status_at_recruitment))
max(table(demographic_table$smoking_status_at_recruitment))

mean(demographic_table$mets_imaging_visit1, na.rm = T)
median(demographic_table$mets_imaging_visit1, na.rm = T)
```

```{r demographics_whole_sample}

# calculate average and median age of whole sample
mean(demographic_table$age_at_recruitment, na.rm = T)
median(demographic_table$age_at_recruitment, na.rm = T)

table(demographic_table$ethnicity_at_recruitment)

mean(demographic_table$deprivation_index, na.rm = T)
median(demographic_table$deprivation_index, na.rm = T)

(table(demographic_table$alc_intake_at_recruitment))

(table(demographic_table$smoking_status_at_recruitment))
max(table(demographic_table$smoking_status_at_recruitment))

mean(demographic_table$mets_imaging_visit1, na.rm = T)
median(demographic_table$mets_imaging_visit1, na.rm = T)
```



## Linear Rgeression Models

### Filtering and Data Wrangling for BC patients
```{r LM_BC_vs_no_BC}

stroke_tbl_BC <- stroke_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_stroke = prevalent_status,
                                                                     incident_status_stroke = incident_status)

IHD_tbl_BC <- IHD_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_IHD = prevalent_status,
                                                                     incident_status_IHD = incident_status)

NICM_tbl_BC <- non_IHD_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_NICM = prevalent_status,
                                                                     incident_status_NICM = incident_status)

pericard_tbl_BC <- pericardial_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_pericard = prevalent_status,
                                                                     incident_status_pericard = incident_status)

HF_tbl_BC <- HF_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_HF = prevalent_status,
                                                                     incident_status_HF = incident_status)

myocard_tbl_BC <- HA_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, prevalent_status, incident_status) %>% rename(prev_status_myocard_inf = prevalent_status,
                                                                     incident_status_myocard_inf = incident_status)

diabetes_tbl_BC <- diabetes_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, diabetes_status)

cholesterol_tbl_BC <- cholesterol_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, cholesterol_status)

hypertension_tbl_BC <- hypertension_tbl %>% # dplyr::filter(f.eid %in% BC_ids) %>% 
  dplyr::select(f.eid, hypertension_status)

df_list <- list(
                BC_tbl %>% select(-recruitment_date, -prevalent_status, -incident_status, -BC_diagnosis_date), 
                RT_tbl %>% select(-recruitment_date, -prevalent_status, -incident_status, -RT_session_date),
                demographic_table, diabetes_tbl_BC, hypertension_tbl_BC, cholesterol_tbl_BC,
                IHD_tbl_BC, NICM_tbl_BC, HF_tbl_BC, stroke_tbl_BC, pericard_tbl_BC, myocard_tbl_BC
                )

GLM_df <- df_list %>% reduce(full_join, by='f.eid')

tmp <- GLM_df %>% dplyr:: select(contains("status"))
factor_cols <- names(tmp)

tmp <- GLM_df %>% dplyr:: select(contains("alc"))
factor_cols <- c(factor_cols, names(tmp))

df1 <- GLM_df %>% dplyr:: select(contains("ethnicity"))
factor_cols <- c(factor_cols, names(df1))

GLM_df <- GLM_df %>% mutate(across(all_of(factor_cols), factor))
# data<-replace(df$Marks, df$Marks<0, 0)
GLM_df$recruitment_date <- ymd(GLM_df$recruitment_date)
GLM_df$sex <- factor(GLM_df$sex)
# nrow(GLM_df)
head(GLM_df, 20)
```
#### Linear Regression Model 

```{r}
# continuous <-select_if(GLM_df, is.numeric)
# summary(continuous)
# 
# library(ggplot2)
# ggplot(continuous, aes(x = age_at_recruitment)) +
#     geom_density(alpha = .2, fill = "#FF6666")
names(GLM_df)

test_df <- GLM_df %>% 
  select(f.eid, BC_status, prev_status_stroke, incident_status_stroke)

test_df
# test_df$BC_status<- as.numeric(test_df$BC_status)    
# sum(is.na(test_df$prev_status_stroke))

formula = incident_status_stroke ~ BC_status
formula2 = incident_status_stroke ~ BC_status + age_at_recruitment + ethnicity_at_recruitment + 
  deprivation_index + education_score + diabetes_status + cholesterol_status + hypertension_status

model1 <- glm(formula, data = test_df, family = "binomial")
model2 <- glm(formula2, data = GLM_df, family = "binomial")
summary(model1)
summary(model2)
```


### ...
```{r LM_BC_vs_no_BC_including_Covariates}

```

## Fine Gray Compete Risk Regressions

```{r}

```



