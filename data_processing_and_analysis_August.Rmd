---
title: "Descriptive Statistics and Data Analysis"
author: "Gracia Andriamiadana"
date: "02/08/2023"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(dplyr)
library(magrittr)
library(ggplot2)
setwd("/Users/BHCadmin/Documents/mres_gracia/")
source(file = "functions_for_data_processing.R")
```

## Load and edit data tables
```{r}
BC_tbl = read.csv("BC_patients_in_UKB.tsv", sep = "\t")
sum(BC_tbl$BC_status)

RT_tbl = read.csv("RT_patients_in_UKB.tsv", sep = "\t")
RT_tbl$RT_status <- NULL
RT_tbl$RT_status <- ifelse(RT_tbl$RT_date_icd10 == '' & RT_tbl$RT_date_opcs4 == '', 0, 1) 
# length(unique(RT_tbl$f.eid)) == nrow(RT_tbl) 
sum(RT_tbl$RT_status)

demographic_table <- read.csv("upd_demographics_table_UKB_data.tsv", header = T, sep = "\t")
diabetes_tbl = read.csv("summarised_diabetes_patients_in_UKB.tsv", sep = "\t")
stroke_tbl = read.csv("summarised_stroke_patients_in_UKB.tsv", sep = "\t")
hypertension_tbl = read.csv("summarised_hypertension_patients_in_UKB.tsv", sep = "\t")
cholesterol_tbl = read.csv("summarised_cholesterol_patients_in_UKB.tsv", sep = "\t")
IHD_tbl = read.csv("summarised_IHD_patients_in_UKB.tsv", sep = "\t")
non_IHD_tbl = read.csv("summarised_non_IHD_patients_in_UKB.tsv", sep = "\t")
HF_tbl = read.csv("summarised_heart_failure_patients_in_UKB.tsv", sep = "\t")
HA_tbl = read.csv("summarised_heart_attack_patients_in_UKB.tsv", sep = "\t")
pericardial_tbl <- read.csv("summarised_pericardial_patients_in_UKB.tsv", sep = "\t")
sample_df <- read.csv("analysis_sample_UKB_patients.tsv", sep = "\t")

View(sample_df)
```
```{r}
library(dplyr)
library(lubridate)

tmp_stroke_tbl <- stroke_tbl %>% filter(Stroke_Status>0)
nrow(tmp_stroke_tbl)

tmppp <- stroke_tbl %>% gather(key, value, -c(f.eid, Stroke_Status)) %>%
  mutate(date= str_sub(value, 1, 11)) 
tmppp$date <- ymd(tmppp$date)
tmppp       

unique(tmppp$date)

x <- tmppp %>% 
  select(f.eid, Stroke_Status, date) %>% 
  group_by(f.eid, Stroke_Status) %>% summarise(minnn = min(date))

View(x)
tmppp1 <- tmppp %>% 
  select(f.eid, Stroke_Status, date) %>% 
  group_by(f.eid, Stroke_Status) %>% summarise(minDate= min(date))

View(tmppp1)

temp_df <- sample_df %>% select(f.eid, recruitment_date) 
temp_df$recruitment_date <- ymd(temp_df$recruitment_date)

tmppp12 <- full_join(temp_df, tmppp1, by = "f.eid") %>% 
  mutate(prevalent_status = ifelse(minDate <= recruitment_date,1,0),
         incident_status = ifelse(minDate > recruitment_date, 1, 0))

tmppp12$prevalent_status <- replace(tmppp12$prevalent_status,is.na(tmppp12$prevalent_status),0)
tmppp12$incident_status <- replace(tmppp12$incident_status,is.na(tmppp12$incident_status),0)

tmppp12
View(tmppp12)
```



```{r relabelling_cases}
 
t0<- stroke_tbl %>% gather(key, value, -c(f.eid, Stroke_Status)) %>%
  mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
  select(f.eid, Stroke_Status, date) %>% 
  group_by(f.eid, Stroke_Status) %>% summarise(minDate= min(date))

# t0<- IHD_tbl %>% gather(key, value, -c(f.eid, IHD_status)) %>%
#   mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
#   select(f.eid, IHD_status, date) %>% 
#   group_by(f.eid, IHD_status) %>% summarise(minDate= min(date))
# 
# t0<- non_IHD_tbl %>% gather(key, value, -c(f.eid, non_IHD_status)) %>%
#   mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
#   select(f.eid, non_IHD_status, date) %>% 
#   group_by(f.eid, non_IHD_status) %>% summarise(minDate= min(date))
# 
# t0<- HF_tbl %>% gather(key, value, -c(f.eid, HF_status)) %>%
#   mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
#   select(f.eid, HF_status, date) %>% 
#   group_by(f.eid, HF_status) %>% summarise(minDate= min(date))
# 
# t0<- HA_tbl %>% gather(key, value, -c(f.eid, HA_status)) %>%
#   mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
#   select(f.eid, HA_status, date) %>% 
#   group_by(f.eid, HA_status) %>% summarise(minDate= min(date))

# t0<- pericardial_tbl %>% gather(key, value, -c(f.eid, pericard_status)) %>% 
#   mutate(date= str_sub(value, 1, 10) %>% ymd()) %>% 
#   select(f.eid, pericard_status, date) %>% 
#   group_by(f.eid, pericard_status) %>% summarise(minDate= min(date))

t0$minDate <- ymd(t0$minDate)

View(t0)

temp_df <- sample_df %>% select(f.eid, recruitment_date) 
temp_df$recruitment_date <- ymd(temp_df$recruitment_date)

t2 <- full_join(temp_df, t1, by = "f.eid") %>% 
  mutate(prevalent_status = ifelse(minDate <= recruitment_date,1,0),
         incident_status = ifelse(minDate > recruitment_date, 1, 0))

t2$prevalent_status <- replace(t2$prevalent_status,is.na(t2$prevalent_status),0)
t2$incident_status <- replace(t2$incident_status,is.na(t2$incident_status),0)

# updated_pericardial_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))
updated_stroke_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))
# updated_IHD_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))
# updated_non_IHD_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))
# updated_HA_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))
# updated_HF_tbl <- tidyr::replace_na(t2, list(prevalent_status=0, incident_status=0))

# write.table(updated_IHD_tbl, file = "updated_IHD_tbl.tsv", sep = "\t")
# write.table(updated_non_IHD_tbl, file = "updated_non_IHD_tbl.tsv", sep = "\t")
# write.table(updated_HF_tbl, file = "updated_HF_tbl.tsv", sep = "\t")
# write.table(updated_HA_tbl, file = "updated_HA_tbl.tsv", sep = "\t")
# write.table(updated_pericardial_tbl, file = "updated_pericardial_tbl.tsv", sep = "\t")
# write.table(updated_stroke_tbl, file = "updated_stroke_tbl.tsv", sep = "\t")
```

## Baseline Characteristics of Whole Sample

### CVDs

```{r whole_sample_CVDs}

paste("Prevelant Cases of Pericardial Disease:", sum(updated_pericardial_tbl$prevalent_status))
paste("Incident Cases of Pericardial Disease", sum(updated_pericardial_tbl$incident_status))

```

### Demographics

```{r demographics_whole_sample}
View(t3)

# calculate average and median age of whole sample
mean(demographic_table$age_at_recruitment, na.rm = T)
median(demographic_table$age_at_recruitment, na.rm = T)

table(demographic_table$ethnicity_at_recruitment)

mean(demographic_table$deprivation_index, na.rm = T)
median(demographic_table$deprivation_index, na.rm = T)

(table(demographic_table$alc_intake_at_recruitment))

(table(demographic_table$smoking_status_at_recruitment))
max(table(demographic_table$smoking_status_at_recruitment))

mean(demographic_table$mets_imaging_visit1, na.rm = T)
median(demographic_table$mets_imaging_visit1, na.rm = T)
```


